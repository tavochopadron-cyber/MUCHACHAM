# -*- coding: utf-8 -*-
"""pp.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1IbyvnZv6n-cLtW1BXrDagJMrbfVoO3xE
"""

!pip install cryptography
# -*- coding: utf-8 -*-
"""Versi칩n completa con MongoDB + correcciones de S칤/No + Cifrado AES-256 Real"""
!pip install dnspython
!pip install streamlit pymongo[srv]
!pip install cryptography

import random
import base64
import secrets
from collections import defaultdict
from pymongo import MongoClient
# 游냀 Nuevos imports para Cifrado
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes
from cryptography.hazmat.backends import default_backend

# ================================
# 游댯  CONEXI칍N A MONGODB
# ================================
# 丘멆잺 REEMPLAZA TU CADENA DE MONGODB AQU칈
MONGO_URI = "mongodb+srv://tavo_user:1234567#@cluster0.cjx2xfb.mongodb.net/?appName=Cluster0"
client = MongoClient(MONGO_URI)
db = client["bricos_db"]
coleccion = db["candidatos"]

# ================================
# 游댯  PAR츼METROS
# ================================
NUM_PREGUNTAS_TECNICAS = 12
NUM_PREGUNTAS_BLANDAS = 13
PUNTAJE_MINIMO_BLANDAS = 0.45

# ================================
# 游댯  CLASE DE CIFRADO SIM칄TRICO (AES)
# ================================
class AESCipher:
    """Clase para cifrar y descifrar usando AES-256."""
    def __init__(self):
        # Generar una clave "p칰blica" simulada y un salt 칰nico para la derivaci칩n
        self.salt = secrets.token_bytes(16)
        self.public_key = base64.urlsafe_b64encode(secrets.token_bytes(32)).decode("utf-8")

        # 1. Derivar la clave AES (32 bytes = 256 bits)
        kdf = PBKDF2HMAC(
            algorithm=hashes.SHA256(),
            length=32,
            salt=self.salt,
            iterations=480000, # Alto n칰mero de iteraciones para resistencia (KDF)
            backend=default_backend()
        )
        self.key = kdf.derive(self.public_key.encode("utf-8"))

    def cifrar(self, datos):
        """Cifra los datos usando AES-256 en modo GCM (con autenticaci칩n)."""
        datos_bytes = datos.encode("utf-8")
        iv = secrets.token_bytes(12) # Initialization Vector (IV)

        # Cifrador GCM (Galois Counter Mode)
        cipher = Cipher(algorithms.AES(self.key), modes.GCM(iv), backend=default_backend())
        encryptor = cipher.encryptor()

        ciphertext = encryptor.update(datos_bytes) + encryptor.finalize()
        tag = encryptor.tag

        # Concatenar IV, Salt, Tag y texto cifrado. Luego codificar en Base64.
        datos_cifrados = iv + self.salt + tag + ciphertext
        return base64.urlsafe_b64encode(datos_cifrados).decode("utf-8")

# ================================
# 游댯  PREGUNTAS T칄CNICAS
# ================================
PREGUNTAS_TECNICAS = [
    "쯉abe realizar inventarios f칤sicos y conteos r치pidos de material de construcci칩n?",
    "쮿a utilizado alg칰n software de Punto de Venta (POS) o sistema de facturaci칩n electr칩nica?",
    "쯉abe leer e interpretar una hoja de ruta o usar GPS para optimizar entregas?",
    "쯊iene experiencia o conoce el manejo b치sico de un montacargas o pat칤n hidr치ulico?",
    "쯇uede identificar y diferenciar los tipos de cemento, varilla y arena comunes en la construcci칩n?",
    "쯉abe c칩mo se calcula el volumen o 치rea de un material (ej. m췁 de arena, m de loseta)?",
    "쯉e siente c칩modo manejando una terminal bancaria y realizando cobros con tarjeta?",
    "쯇uede verificar y cotejar una orden de compra contra el material f칤sico que se va a cargar?",
    "쮺onoce las normas b치sicas de seguridad para cargar y descargar materiales pesados?",
    "쯊iene conocimientos b치sicos de uso de hojas de c치lculo (Excel, Google Sheets) para reportes?",
    "쯉abe realizar el mantenimiento b치sico o limpieza de herramientas y equipos de trabajo?",
    "쯇uede calcular r치pidamente el cambio para un pago en efectivo?"
]

PREGUNTAS_BLANDAS = [
    "쯄antiene la calma y es cort칠s al tratar con un cliente enojado o impaciente?",
    "쯉e adapta f치cilmente a los cambios de tareas o prioridades de 칰ltima hora?",
    "쯆frece ayuda a sus compa침eros sin que se lo pidan?",
    "쮼s puntual y respeta estrictamente los horarios?",
    "쮸cepta retroalimentaci칩n sin ponerse a la defensiva?",
    "쯉e enfoca en soluciones en lugar de culpar a otros?",
    "쮼s proactivo buscando tareas pendientes?",
    "쯉e comunica de manera clara y concisa?",
    "쯊rabaja bien bajo presi칩n?",
    "쯉u honestidad y 칠tica son inquebrantables?",
    "쯇rioriza la seguridad ante todo?",
    "쯇ropone mejoras a procesos ineficientes?",
    "쯉e siente c칩modo pidiendo al cliente verificar la carga/ticket?"
]

# ================================
# 游댯  츼REAS
# ================================
AREAS = {
    "CARGADOR":        [0, 3, 4, 7, 8],
    "VENTAS/COBRANZA": [1, 6, 11],
    "REPARTIDOR":      [2, 3, 7, 8],
    "LIMPIEZA":        [10],
    "ADMINISTRATIVO":  [9, 1, 5]
}

def asignar_area(respuestas):
    conteo = defaultdict(int)
    for area, indices in AREAS.items():
        conteo[area] = sum(1 for i in indices if respuestas[i] == "S칤")

    if not any(conteo.values()):
        return max(AREAS, key=lambda a: len(AREAS[a]))

    return max(conteo, key=conteo.get)

# ================================
# 游댯  SELECCI칍N DE 츼REA DESEADA
# ================================
def seleccionar_area_deseada():
    opciones = {
        "1": "CARGADOR",
        "2": "VENTAS/COBRANZA",
        "3": "REPARTIDOR",
        "4": "LIMPIEZA",
        "5": "ADMINISTRATIVO"
    }

    print("\n--- PUESTO AL QUE DESEAS APLICAR ---")
    for k, v in opciones.items():
        print(f"{k}. {v}")

    while True:
        eleccion = input("Elige una opci칩n (1-5): ").strip()
        if eleccion in opciones:
            return opciones[eleccion]
        print("Opci칩n no v치lida.")

# ================================
# 游댯  DATOS PERSONALES
# ================================
def pedir_datos_personales():
    def pedir(m):
        while True:
            x = input(m).strip()
            if x: # Added condition and colon here
                return x
            print("No puede quedar vac칤o.")